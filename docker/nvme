#!/bin/bash

# NVMe-oF commands need to run on the host system
# Use nsenter for compatibility with Talos and other minimal OS

: "${NVME_HOST_STRATEGY:=nsenter}"

# Find nvme binary - check multiple possible locations (varies by OS/distro)
find_nvme() {
  for path in /usr/local/sbin/nvme /usr/sbin/nvme /sbin/nvme /usr/bin/nvme /usr/local/bin/nvme; do
    if [[ -x "/host${path}" ]]; then
      echo "${path}"
      return
    fi
  done
  # Fallback to default
  echo "/usr/sbin/nvme"
}

: "${NVME_HOST_PATH:=$(find_nvme)}"

echoerr() { printf "%s\n" "$*" >&2; }

case ${NVME_HOST_STRATEGY} in
  chroot)
    chroot /host ${NVME_HOST_PATH} "${@:1}"
    ;;

  nsenter)
    # Find nvme-related process by scanning /host/proc (since regular pgrep only sees container processes)
    nvme_pid=""
    for pid_dir in /host/proc/[0-9]*; do
      pid=$(basename "${pid_dir}")
      if [[ -f "${pid_dir}/comm" ]]; then
        comm=$(cat "${pid_dir}/comm" 2>/dev/null)
        if [[ "${comm}" == "nvme-cli" ]] || [[ "${comm}" == "nvme" ]]; then
          nvme_pid="${pid}"
          break
        fi
      fi
    done
    if [[ "${nvme_pid}x" == "x" ]]; then
      # Fallback to chroot if no nvme process found (nvme-cli doesn't have a daemon)
      chroot /host ${NVME_HOST_PATH} "${@:1}"
    else
      nsenter --mount="/host/proc/${nvme_pid}/ns/mnt" --net="/host/proc/${nvme_pid}/ns/net" -- ${NVME_HOST_PATH} "${@:1}"
    fi
    ;;

  *)
    echoerr "invalid NVME_HOST_STRATEGY: ${NVME_HOST_STRATEGY}"
    exit 1
    ;;
esac
