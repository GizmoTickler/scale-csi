#!/bin/bash

# NVMe-oF commands need to run on the host system
# Use nsenter for compatibility with Talos and other minimal OS

: "${NVME_HOST_STRATEGY:=auto}"

# Find nvme binary - check multiple possible locations (varies by OS/distro)
find_nvme() {
  for path in /usr/local/sbin/nvme /usr/sbin/nvme /sbin/nvme /usr/bin/nvme /usr/local/bin/nvme; do
    if [[ -x "/host${path}" ]]; then
      echo "${path}"
      return
    fi
  done
  # Fallback to default
  echo "/usr/sbin/nvme"
}

: "${NVME_HOST_PATH:=$(find_nvme)}"

echoerr() { printf "%s\n" "$*" >&2; }

case ${NVME_HOST_STRATEGY} in
  chroot)
    chroot /host ${NVME_HOST_PATH} "${@:1}"
    ;;

  nsenter)
    # Unlike iSCSI (which has iscsid daemon), nvme-cli is a one-shot command.
    # Use nsenter with PID 1 (init) to access the host namespace.
    # This works on Talos and other minimal OS where chroot may not work.
    nsenter --mount="/host/proc/1/ns/mnt" --net="/host/proc/1/ns/net" -- ${NVME_HOST_PATH} "${@:1}"
    ;;

  auto)
    # Auto mode: try chroot first (works on standard distros),
    # fallback to nsenter with PID 1 (works on Talos/minimal OS)
    if chroot /host ${NVME_HOST_PATH} "${@:1}" 2>/dev/null; then
      exit 0
    fi
    nsenter --mount="/host/proc/1/ns/mnt" --net="/host/proc/1/ns/net" -- ${NVME_HOST_PATH} "${@:1}"
    ;;

  *)
    echoerr "invalid NVME_HOST_STRATEGY: ${NVME_HOST_STRATEGY}"
    exit 1
    ;;
esac
